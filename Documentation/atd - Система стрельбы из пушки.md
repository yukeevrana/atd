---
tags:
  - система
  - circle-is-not-right
  - стрельба
  - пушка
  - огнестрельное-оружие
date: 2026-02-17T14:27:00
---

---
# Система стрельбы из пушки

## Основное описание

Система стрельбы из пушки - базовое вооружение [[atd - Круг|башни]]. Она доступно с самого начала, позволяет башне стрелять в направлении курсора, когда игрок кликает куда-либо на экране. В момент выстрела в центре башни появляется снаряд и начинает лететь в сторону курсора. Он существует какое-то время, после чего исчезает. 

## Графика

Для системы стрельбы из пушки нет дополнительных спецэффектов. Снаряд - маленький белый круг. Для снаряда используется спрайт башни, но сильно уменьшенный: `Assets/Sprites/tower.png`. 

## Техническое описание

Скрипт, где описана система: `Scripts/TowerManager.cs`

Префаб снаряда: `Assets/Prefabs/bullet.prefab`

Используется пул объектов (`List<SpawnedCannonBullet> bulletObjs` и `Stack<int> notActiveBulletIds`), который позволяет не уничтожать использованные объекты снарядов, а переиспользовать их повторно. Система отключает снаряды, когда те должны быть уничтожены, и включает отключенные, когда нужно создать новый. Механика выстрела описана в методе `void FireBullet(FireCommand cmd)`. 

При выстреле, если нет отключенного снаряда, для каждого экземпляра объекта инициализируются:
- Префаб объекта через `Addressables.InstantiateAsync("BulletPrefab")`
- Структура `SpawnedCannonBullet` (`Scripts/Data.cs`), хранящая ссылку на `GameObject` и ссылку на `AsyncOperationHandle`

Система использует буфер команд `List<FireCommand> commandBuffer`. Через Input System каждый кадр считывается сигнал о стрельбе (`void UpdateInput()`). Если считан, создаётся команда `FireCommand` (`Scripts/Commands.cs`), в которую сохраняется позиция, в которую должен быть произведён выстрел и идентификатор башни. Команда помещается в буфер. 

Каждый кадр обрабатывается список команд (`void ProcessCommands()`). Команда `FireCommand` обрабатывается методом `void FireBullet(FireCommand cmd)`. 

Метод `void OperateBullets()` отвечает за отключение отработавших пулек и вызывается каждый кадр для отслеживания времени жизни всех снарядов. 


---
## Links


---